import { promises as fs } from "node:fs";
import path from "node:path";
import { fileURLToPath } from "node:url";

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const swiftHeader = `// Generated by scripts/generate-swift-schemas.ts â€” do not edit directly.\n// swiftlint:disable all\nimport Foundation\n\n`;

const swiftBody = `public struct CreditSummary: Codable, Equatable {\n    public let balance: Int\n    public let planDisplayName: String\n    public let estimatedShootsRemaining: Double\n}\n\npublic struct ProviderCapabilityPayload: Codable, Equatable {\n    public struct SupportedOutputs: Codable, Equatable {\n        public let stars: Bool\n        public let colors: Bool\n        public let title: Bool\n        public let description: Bool\n        public let tags: Bool\n    }\n\n    public let id: String\n    public let vendor: String\n    public let displayName: String\n    public let description: String\n    public let vision: Bool\n    public let structuredOutput: Bool\n    public let offline: Bool\n    public let maxBatchImages: Int\n    public let maxParallelBatches: Int\n    public let maxBatchMegabytes: Int?\n    public let supportsMetadataWriteback: Bool\n    public let supportedOutputs: SupportedOutputs\n    public let supportsVoicePrompts: Bool\n    public let supportsAudioAnnotations: Bool\n    public let recommendedUse: String\n    public let estimatedCostPer1kImages: Double\n}\n\npublic struct PromptStylePayload: Codable, Equatable {\n    public let starMeaning: [String: String]\n    public let colorMeaning: [String: String]?\n    public let includeTitle: Bool\n    public let includeDescription: Bool\n    public let includeTags: Bool\n}\n\npublic struct PromptPresetPayload: Codable, Equatable {\n    public struct PhotographerProfile: Codable, Equatable {\n        public let id: String?\n        public let email: String\n        public let displayName: String\n        public let bio: String\n        public let avatarUrl: String?\n    }\n\n    public let id: String?\n    public let slug: String\n    public let title: String\n    public let summary: String\n    public let instructions: String\n    public let shootTypes: [String]\n    public let tags: [String]\n    public let authorProfile: PhotographerProfile\n    public let aiScore: Double?\n    public let humanScore: Double?\n    public let ratingsCount: Int\n    public let style: PromptStylePayload\n    public let createdAt: String?\n    public let updatedAt: String\n    public let sharedWithMarketplace: Bool\n}\n\npublic struct CreditLedgerMetadataPayload: Codable, Equatable {\n    public let providerId: String?\n    public let shootId: String?\n    public let imagesProcessed: Int?\n}\n\npublic struct CreditLedgerEntryPayload: Codable, Equatable {\n    public let id: String?\n    public let userId: String\n    public let entryType: String\n    public let credits: Double\n    public let description: String?\n    public let metadata: CreditLedgerMetadataPayload?\n    public let createdAt: String?\n}\n\npublic struct MetadataUpdatePayload: Codable, Equatable {\n    public let imageId: String\n    public let starRating: Int?\n    public let colorLabel: String?\n    public let title: String?\n    public let description: String?\n    public let tags: [String]?\n}\n\npublic struct StructuredOutputRatingPayload: Codable, Equatable {\n    public let imageId: String\n    public let starRating: Int\n    public let colorLabel: String\n    public let title: String?\n    public let description: String?\n    public let tags: [String]?\n    public let aiConfidence: Double?\n}\n\npublic struct StructuredOutputPayload: Codable, Equatable {\n    public let jobId: String\n    public let batchId: String\n    public let ratings: [StructuredOutputRatingPayload]\n    public let aggregateNotes: String?\n}\n\npublic struct ImageMetadataPayload: Codable, Equatable {\n    public struct Exposure: Codable, Equatable {\n        public let shutterSpeed: String?\n        public let aperture: String?\n        public let iso: Int?\n        public let focalLength: String?\n        public let exposureCompensation: String?\n    }\n\n    public struct NearbyVenue: Codable, Equatable {\n        public let name: String\n        public let category: String?\n        public let distanceMeters: Double?\n    }\n\n    public struct Gps: Codable, Equatable {\n        public let latitude: Double\n        public let longitude: Double\n        public let altitude: Double?\n        public let resolvedAddress: String?\n        public let nearbyVenues: [NearbyVenue]?\n    }\n\n    public struct Iptc: Codable, Equatable {\n        public let title: String?\n        public let description: String?\n        public let keywords: [String]?\n        public let people: [String]?\n        public let clientName: String?\n        public let eventName: String?\n        public let location: Location?\n\n        public struct Location: Codable, Equatable {\n            public let city: String?\n            public let state: String?\n            public let country: String?\n        }\n    }\n\n    public let id: String?\n    public let filename: String\n    public let relativePath: String\n    public let fileHash: String\n    public let byteSize: Int\n    public let captureDate: String\n    public let cameraMake: String?\n    public let cameraModel: String?\n    public let lensModel: String?\n    public let exposure: Exposure?\n    public let gps: Gps?\n    public let width: Int\n    public let height: Int\n    public let iptc: Iptc?\n}\n`;

const output = swiftHeader + swiftBody;

const targets = [
  path.resolve(__dirname, "../apps/mac-menubar/Sources/KullMenubar/Generated/SharedSchemas.swift"),
  path.resolve(__dirname, "../apps/mobile-companion/Sources/KullMobile/Generated/SharedSchemas.swift"),
];

async function run() {
  await Promise.all(
    targets.map(async (target) => {
      await fs.mkdir(path.dirname(target), { recursive: true });
      await fs.writeFile(target, output, "utf8");
    }),
  );
  console.log("Generated Swift schema stubs:", targets.map((t) => path.relative(path.resolve(__dirname, ".."), t)).join(", "));
}

run().catch((error) => {
  console.error("Failed to generate Swift schemas", error);
  process.exitCode = 1;
});
